[
["spatial-data.html", "Глава 6 Пространственные данные в R 6.1 Модели пространственных данных 6.2 Пространственная привязка 6.3 Векторные данные 6.4 Контрольные вопросы и задачи", " Глава 6 Пространственные данные в R Необходимые пакеты: sf, raster, dplyr, RColorBrewer Данный модуль посвящен введению в работу с пространственными данными в R. Рассмотрены общие вопросы моделирования реального мира средствами моделей пространственных данных. Рассматривается чтение векторных и растровых данных, их визуализация стандартными средствами. 6.1 Модели пространственных данных Пространственные данные — это данные о пространственных объектах и их наборах. В свою очередь, пространственный объект определяется как цифровая модель материального или абстрактного объекта реального или виртуального мира с указанием его идентификатора, координатных и атрибутивных данных.1 Если говорить по сути, то пространственные данные можно определить как данные о географических объектах или явлениях, фиксирующие их местоположение и/или распределение в системе координат, привязанной к телу Земли или любого другого небесного тела. Таким образом, отличительной особенностью пространственных данных перед непространственными является координатное описание местоположения. Важно знать отличия между векторной и растровой моделью пространственных данных. Векторная модель пространственных данных включает описание координатных данных пространственных объектов и, возможно, топологических отношений между ними. Векторные данные фиксируют местоположение и форму объектов в виде геометрических примитивов, таких как точки, линии, полигоны, объемные тела. Выбор модели объекта (например, представить город точкой или полигоном) зависит от масштаба анализа и целей исследования. Векторная модель данных является объектно-ориентированной. Растровая модель описывает не объекты, а пространственное распределение некоторой (выбранной исследователем) характеристики. Пространство разбивается регулярной сеткой ячеек, в каждой ячейке фиксируется значение исследуемого параметра (путем статистического осреднения, семплирования в центре ячейки и т.п.). Растровые данные могут быть как количественными (например, поле температуры), так и качественными (например, растр классифицированного снимка, каждая ячейка которого фиксирует принадлежность к тому или иному типу объекта). Таким образом, растровая модель является пространственно-ориентированной (или феномен-ориентированной). Существуют и другие модели пространственных данных, однако их рассмотрение выходит за рамки настоящей лекции. В настоящей лекции мы познакомимся с чтением и визуализацией пространственных данных в векторном и растровом формате, а также рассмотрим вопросы связанные с использованием картографических проекций. 6.1.1 Векторные данные Simple Features (официально Simple Features Access) — это стандарт OGC 06-103, разработанный Open Geospatial Consortium (OGC) и реализованный также в виде международного стандарта ISO 19125, который определяет общую модель хранения и доступа к векторным объектам (точка, линия, многоугольник, мульти точечные, мультилинии и т. д.), в географических информационных системах. Геометрическое представление пространственных объектов базируется на следующих принципах: Все геометрии состоят из точек. Точки являются координатами в 2-, 3- или 4-мерном пространстве. Все точки в геометрии имеют одинаковую размерность. В дополнение к координатам \\(X\\) и \\(Y\\) имеются два дополнительных дополнительных параметра: координата \\(Z\\), обозначающая высоту координата \\(M\\), обозначающая некоторую меру, связанную с точкой, а не с признаком в целом (в этом случае это будет атрибут объекта). Измерение \\(M\\) может быть использовано, например, для представления времени или линейных координат (для маршрутов). Координаты простой геометрии всегда содержат компоненты \\(X\\) и \\(Y\\), поэтому все разнообразие возможных представлений определяется наличием или отсутствием дополнительных измерений \\(Z\\) и \\(M\\) Таким образом, получаем четыре варианта геометрии: двумерные точки \\(XY\\) трехмерные точки \\(XYZ\\) трехмерные точки \\(XYM\\) четырехмерные точки \\(XYZM\\) В случае использования широт и долгот \\(X\\) соответствует долготе, \\(Y\\) соответствует широте. Всего стандарт Simple Features включает в себя 17 типов геометрий. Из них наиболее употребительными являются следующие 7: Тип Описание POINT нуль-мерная геометрия, содержащая одну точку LINESTRING последовательность точек, соединенных прямыми, несамопересекающимися отрезками; одномерная геометрия POLYGON геометрия с положительной площадью (двумерная); последовательность точек, отрезки между которыми формируют замкнутое кольцо без самопересечений; первое кольцо является внешним, ноль и более остальных колец представляют дырки внетри полигона MULTIPOINT множество точек; геометрия типа MULTIPOINT называется простой если ни одна пара точек в MULTIPOINT не совпадает MULTILINESTRING множество линий MULTIPOLYGON множество полигонов GEOMETRYCOLLECTION множество геометрий произвольного типа за исключением GEOMETRYCOLLECTION Примеры различных видов геометрий представлены на рисунке ниже: ## Загрузка требуемого пакета: methods ## Linking to GEOS 3.6.1, GDAL 2.1.3, proj.4 4.9.3 Оставшиеся виды геометрий Simple Features включают: CIRCULARSTRING, COMPOUNDCURVE, CURVEPOLYGON, MULTICURVE, MULTISURFACE, CURVE, SURFACE, POLYHEDRALSURFACE, TIN, TRIANGLE. Существует два официально закрепленных формата представления SF: Well-Known Text (WKT) и Well-Known Binary (WKB), которые необходимы для чтения таких данных человеком и машиной соответственно. Well-Known Text (WKT) — стандарт представления геометрии в виде множества списков координат, в которых координаты вершин разделены пробелами, вершины разделены запятыми, а компоненты полигонов и мультигеометрий заключены в круглые скобки и также разделены запятыми. Вышеприведенной картинке соответствуют следующие строки WKT: ## MULTIPOINT (3.2 4, 3 4.6, 3.8 4.4, 3.5 3.8, 3.4 3.6, 3.9 4.5) ## LINESTRING (0 3, 0 4, 1 5, 2 5) ## MULTILINESTRING ((0 3, 0 4, 1 5, 2 5), (0.2 3, 0.2 4, 1 4.8, 2 4.8), (0 4.4, 0.6 5)) ## POLYGON ((0 0, 1 0, 3 2, 2 4, 1 4, 0 0), (1 1, 1 2, 2 2, 1 1)) ## MULTIPOLYGON (((0 0, 1 0, 3 2, 2 4, 1 4, 0 0), (1 1, 1 2, 2 2, 1 1)), ((3 0, 4 0, 4 1, 3 1, 3 0), (3.3 0.3, 3.3 0.8, 3.8 0.8, 3.8 0.3, 3.3 0.3)), ((3 3, 4 2, 4 3, 3 3))) ## GEOMETRYCOLLECTION (MULTIPOINT (3.2 4, 3 4.6, 3.8 4.4, 3.5 3.8, 3.4 3.6, 3.9 4.5), MULTIPOLYGON (((0 0, 1 0, 3 2, 2 4, 1 4, 0 0), (1 1, 1 2, 2 2, 1 1)), ((3 0, 4 0, 4 1, 3 1, 3 0), (3.3 0.3, 3.3 0.8, 3.8 0.8, 3.8 0.3, 3.3 0.3)), ((3 3, 4 2, 4 3, 3 3))), LINESTRING (0 3, 0 4, 1 5, 2 5)) Well-Known Binary (WKB) — бинарный формат хранения координат. Именно этот формат фактически используется в базах данных, поскольку он обеспечивает высокую скорость чтения и записи данных (в отлиие от текстового). Однако внешний вид данных в формате WKB мало о чем говорит человеку, поскольку он предназначен для чтения компьютером. Например, вышеприведенная строка LINESTRING будет выглядеть так: ## 01 02 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 08 40 00 00 00 00 00 00 00 00 00 00 00 00 00 00 10 40 00 00 00 00 00 00 f0 3f 00 00 00 00 00 00 14 40 00 00 00 00 00 00 00 40 00 00 00 00 00 00 14 40 6.1.2 Растровые данные Растр представляет из себя матрицу значений. Каждой ячейке матрицы соответствует прямоугольная пространственная область фиксированного размера, которая называется пикселом. Различают растры непрерывные и категориальные (классифицированные). Также необходимо разделять одноканальные и многоканальные растры. Примером одноканального растра является цифровая модель рельфа. В виде многоканальных растров часто представляют космические снимки. В отличие от векторных данных, которые требут указания координат для каждой вершины, регулярно-ячеистый характер растровой модели позволяет вычислять координаты пикселов на основе их индексов. Поэтому фактически растровые данные хранятся в виде линейно упорядоченного списка значений (raster values) и описания геометрии растра (raster geometry). Геометрия растра определяет, где именно располагаются в пространстве пикселы растра и может быть описана путем указания следующих компонент2: Параметр Назначение NCOLS Количество столбцов NROWS Количество строк XLLCENTER Координата \\(X\\) центра левой нижней ячейки растра YLLCENTER Координата \\(Y\\) центра левой нижней ячейки растра CELLSIZE Размер ячейки Иногда вместо параметров XLLCENTER/YLLCENTER указываются XLLCORNER/YLLCORNER, которые кодируют координаты левого нижнего угла, а не центра левой нижней ячейки растра. Выбор одного из двух этих вариантов определяет тип регистрации растра, а их значения указывают, в какое именно место необходимо “посадить” растр, чтобы его ячейки заняли соответствующие им области в системе координат. Если геометрия растра характеризуется анизотропией, то вместо одного значения CELLSIZE могут быть указаны разные размеры ячеек по осям координат CELLSIZEX и CELLSIZEY. В отличие от векторной модели, которая позволяет хранить данные только о нужных географических локациях, растровая модель такой свободы не предоставляет. Матрица ячеек растра всегда покрывает область данных целиком, и за простоту растровой структуры приходится расплачиваться ее неэкономичностью. Поскольку часто данные имеются не на всю территорию, возникает необходимость кодирования ячеек, для которых данные не известны, специальным числом (назовем его условно NODATA_VALUE). Значение этого числа хранится в метаданных растра и позволяет интерпретировать соответствующие ячейки как пустые. 6.2 Пространственная привязка 6.2.1 Компоненты пространственной привязки Пространственная привязка (spatial reference или georeference) — важнейшая составляющая пространственных данных, которая говорит нам о том, как правильно интерпретировать координаты объектов. Пространственная привязка в простейшем случае включает несколько фундаментальных компонент: Эллипсоид вращения — тело, по отношению к которому вычисляются геодезические координаты точек (широты и долготы) Исходные геодезические даты (датум) — параметры положения эллипсоида в теле Земли Географическая система координат — включает датум, положение начального меридиана и единицы измерения широт и долгот Проекция — математический спопоб перехода от географических координат на эллипсоиде к плоским прямоугольным координатам карты. Плоская прямоугольная система координат — включает проекцию, ее параметры и единицы измерения координат. Если точки имеют также координаты \\(Z\\), то для их правильной интерпретации необходимы дополнительные компоненты пространственной привязки: Система счета высот (геодезические, нормальные, ортометрические) - определяют содержательный смысл и порядок вычисления высот и глубин (координата Z) Модель геоида, квазигеоида или эллипсоида — определяет поверхность, относительно которой вычисляются высоты точек. Вертикальная система координат — фактическая реализация системы счета высот относительно конкретной поверхности относимости с заданным положением нулевого уровня. Например, в России это Балтийская система нормальных высот с нулем в г. Кронштадт. Аналогичным образом требуется введение системы счета дополнительных координат \\(M\\), если они используются в представлении координат. 6.2.2 Форматы описания пространственной привязки Существует три распространенных способа задания (хранения) пространственной привязки: PROJ.4 String — представление в виде строки. WKT (Well-Known Text) — представление в виде иерархического списка. EPSG (European Petroleum Survey Group) — представление в виде числового кода. Для поиска проекций в перечисленных форматах представления удобно воспользоваться порталом spatialreference.org. PROJ.4 String — строковый формат представления информации о пространственной привязки, используемый в библиотеке PROJ.4. Данная библиотека лежит в основе координатных систем пространственных данных, используется в R, Python, QGIS и прочих средах. Основные параметры строки: +datum Datum name (see `proj -ld`) +ellps Ellipsoid name (see `proj -le`) +lat_0 Latitude of origin +lat_1 Latitude of first standard parallel +lat_2 Latitude of second standard parallel +lat_ts Latitude of true scale +lon_0 Central meridian +proj Projection name (see `proj -l`) +units meters, US survey feet, etc. +vunits vertical units. +x_0 False easting +y_0 False northing +zone UTM zone Примеры записи координат в формате PROJ.4: Географические координаты в WGS84 (без проекции): ## +proj=longlat +datum=WGS84 +no_defs Координаты в проекции Web Mercator (проекция Google Maps, Яндекс.Карт и т.д.): ## +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs Координаты в конической равнопромежуточной проекции: ## +proj=eqdc +lat_0=0 +lon_0=0 +lat_1=60 +lat_2=60 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs Координаты в проекции UTM, зона 37: ## +proj=utm +zone=37 +datum=WGS84 +units=m +no_defs Запись координат в формате WKT предполагает представление вышеуказанных компонент пространственной привязки к виде иерерхического списка. Например, так будет выглядеть информация о полярной стереографической проекции для карт России: PROJCS[&quot;WGS 84 / EPSG Russia Polar Stereographic&quot;, GEOGCS[&quot;WGS 84&quot;, DATUM[&quot;WGS_1984&quot;, SPHEROID[&quot;WGS 84&quot;,6378137,298.257223563, AUTHORITY[&quot;EPSG&quot;,&quot;7030&quot;]], AUTHORITY[&quot;EPSG&quot;,&quot;6326&quot;]], PRIMEM[&quot;Greenwich&quot;,0, AUTHORITY[&quot;EPSG&quot;,&quot;8901&quot;]], UNIT[&quot;degree&quot;,0.0174532925199433, AUTHORITY[&quot;EPSG&quot;,&quot;9122&quot;]], AUTHORITY[&quot;EPSG&quot;,&quot;4326&quot;]], PROJECTION[&quot;Polar_Stereographic&quot;], PARAMETER[&quot;latitude_of_origin&quot;,90], PARAMETER[&quot;central_meridian&quot;,105], PARAMETER[&quot;scale_factor&quot;,0.994], PARAMETER[&quot;false_easting&quot;,2000000], PARAMETER[&quot;false_northing&quot;,2000000], UNIT[&quot;metre&quot;,1, AUTHORITY[&quot;EPSG&quot;,&quot;9001&quot;]], AXIS[&quot;X&quot;,EAST], AXIS[&quot;Y&quot;,NORTH], AUTHORITY[&quot;EPSG&quot;,&quot;5940&quot;]] EPSG (European Petroleum Survey Group) — европейская рабочая группа нефтегазовой области, которая ведет реестр систем координат с уникальными цифровыми кодами вида EPSG:xxxxxx. Коды EPSG оказались настолько удобны, что используются повсеместно для быстрой инициализации проекций со стандартными параметрами. Например, вышеприведенные проекции имеют следующие коды EPSG: WGS84: EPSG:4326 Web Mercator: EPSG:3857 UTM: EPSG:326.. , например для UTM 37N: EPSG:32637 6.2.3 Преобразование координат Преобразование координат включает три различных операции: Трансформирование — пересчет географических координат с одного датума на другой Проецирование — переход от географических координат к плоским прямоугольным Обратное проецирование — переход от плоских координат к прямоугольным. Например, чтобы пересчитать координаты UTM в проекцию Гаусса-Крюгера, необходимо: Обратно проецировать координаты в географические WGS84 Трансформировать географические координаты c WGS84 в ГСК-2011 Проецировать координаты ГСК-2011 в проекцию Гаусса-Крюгера Несоответствие датумов часто является причиной того, что данные из разных наборов плохо совмещаются друг с другом 6.3 Векторные данные 6.3.1 Базовые библиотеки В R существует высоко развитая инфраструктура для работы с векторными данными, которая обеспечивается пакетом sf. Этот пакет появился сосвсем недавно (в 2016 году). Ранее поддержка пространственных данных обеспечивалась пакетом sp, который по прежнему активно используется, и на который “завязано” множество других библиотек. Существующая в настоящий момент инфраструктура кратко показана ниже: Архитектура программных библиотек для работы с пространственными данными в R Исторический пакет sp обеспечивал (и продолжает обеспечивать) поддержку пространственных данных в виде специальных классов данных типа Spatial, реализуя классы как для чисто геометрических объектов (SpatialPolygons), так и для пространственных объектов с атрибутами (SpatialPolygonsDataFrame). Во втором случае набор объектов имеет ассоциированную с ним таблицу атрибутов. С классами типа Spatial существут несколько проблем. Во-первых, они не являются объектами типа data.frame (не расширяют их), а являются самостоятельным классом объектов, поэтому к ним часто невозможно корректно применить стандартные операции трансформации таблиц (типа тех, что доступны в пакете dplyr). Во-вторых, объекты типа Spatial не реализуют существующие стандарты представления пространственных данных (типа Simple Features), что накладывает ограничения на их интероперабельность с современными форматами данных (например, GeoPackage). Пакет sf решает все эти проблемы. Множество функций, которые были раньше разбросаны по нескольким пакетам R (sp, rgdal, rgeos), теперь доступны в одном интерфейсе: library(sf) methods(class = &quot;sf&quot;) # Посмотрим, какие методы доступных для объектов класса sf ## [1] [ [[&lt;- $&lt;- ## [4] aggregate cbind coerce ## [7] initialize merge plot ## [10] print rbind show ## [13] slotsFromS3 st_agr st_agr&lt;- ## [16] st_as_sf st_bbox st_boundary ## [19] st_buffer st_cast st_centroid ## [22] st_collection_extract st_convex_hull st_coordinates ## [25] st_crs st_crs&lt;- st_difference ## [28] st_geometry st_geometry&lt;- st_intersection ## [31] st_is st_line_merge st_make_valid ## [34] st_node st_point_on_surface st_polygonize ## [37] st_precision st_segmentize st_set_precision ## [40] st_simplify st_split st_sym_difference ## [43] st_transform st_triangulate st_union ## [46] st_voronoi st_zm ## see &#39;?methods&#39; for accessing help and source code Cо многими из этих функций мы познакомимся в последующих разделах нашего курса. Некоторые из них (такие как arrange, filter, mutate из пакета dplyr), должны быть уже знакомы вам по предыдущим лекциям. Можно обратить внимание на то, что практически все функции начинаются с префикса st_, что означает “spatiotemporal”. Данные префиксы были выбраны для унификации с аналогичными названиями функций, используемых в широко распространенной СУБД PostgreSQL для оперирования объектами Simple Features. 6.3.2 Чтение векторных данных Существует большое множество форматов хранения пространственных данных. Но в общем и целом их можно разделить на две категории: файловые форматы (наиболее привычные пользователям) и хранение данных в СУБД — системах управления базами данных. Благодаря библиотеке GDAL пакет sf имеет возможность читать и записывать более 90 различных форматов векторных даных. Разумеется, не все из них общеупотребительны. Исторически наиболее распространенным форматом был (и остается) ESRI Shapefile. Данный формат, однако не отвечает современным техническим требованиям с точки зрения гибкости, соответствия стандартам и возможностям хранения разнообразных типов геометрий (напомним, что в стандарте Simple Features их 17, а с учетом четырех вариантов размерности точек получается целых 68 ). Современный формат, который позволяет делать это (и не только), это GeoPackage. Именно его мы и будем использовать в нашем практикуме. Для чтения данных средствами sf необходимо использовать функцию st_read(): countries &lt;- st_read(&#39;ne/countries.gpkg&#39;) ## Reading layer `admin_0_map_units&#39; from data source `/Volumes/Data/GitHub/r-geo-course/data/ne/countries.gpkg&#39; using driver `GPKG&#39; ## Simple feature collection with 183 features and 72 fields ## geometry type: MULTIPOLYGON ## dimension: XY ## bbox: xmin: -180 ymin: -90 xmax: 180 ymax: 83.64513 ## epsg (SRID): 4326 ## proj4string: +proj=longlat +datum=WGS84 +no_defs Лог функции сообщил нам следующую информацию: Набор данных представляет собой коллекцию из 183 пространственных объектов с 72 атрибутами Тип геометрии MULTIPOLYGON Размерность геометрии \\(XY\\) Ограничивающий прямоугольник (разброс координат) по осям \\(X\\) и \\(Y\\) имеет диапазон \\([-180, 180] \\times [-90, 83.64513]\\) EPSG-код пространственной привязки равен 4326 PROJ.4-строка пространственной привязки равна +proj=longlat +datum=WGS84 +no_defs 6.3.3 Внутренняя структура Традиционно во всех ГИС-приложениях и базах пространственных данных множество пространственных объектов представляется в виде таблицы атрибутов, где каждая строка соответствует объекту, а каждый столбец — атрибуту объекта. С каждой строкой таблицы должна быть ассоциирована информация о геометрии объекта, которая, в зависимости от формата данных, может либо храниться непосредственно в таблице (в специальном столбце), либо быть вынесена в отдельную структуру данных, которая связана с таблицей атрибутов посредством ключа3. В R используется первый подход, в котором информация о геометрии хранится в специальном столбце таблицы. Каждая ячейка этого столбца соответствует геометрическому объекту Simple Features. Представление геометрических объектов реализовано стандартными средствами, такими как списки, матрицы и векторы. Эти структуры данных упорядоченным образом хранят координаты объектов и естественным образом соответствуют способу организации данных, который регламентируется стандартом Simple Features. Поскольку геометрический столбец хранит не обычные переменные, а структуры данных, он реализуется в виде так называемого списка-колонки (list-column), каждый элемент которой соответствует отдельному объекту. Исходя из этих соображений, представление пространственных объектов реализовано в R в виде иерархии из трех классов объектов: sf (simple features) — объект класса data.frame, представляющий множество пространственных объектов со списком-колонкой для хранения геометрии sfc (simple features geometry column) — список-колонка в объекте sf, представляющий множество геометрий пространственных объектов sfg (simple feature geometry) — геометрия пространственного объекта внутри списка sfc В соответствии с перечисленными спецификациями происходит работа с пространственными объектами. То что, объекты типа Simple Features реализованы в виде самых обычных фреймов данных, означает что любая операция, применимая к фрейму данных, будет также применима к объекту типа sf. Это очень важная особенность объектов типа sf, которой сильно не хватало в экосистеме исторического пакета sp. Посмотрим, как все это реализовано, на конкретном примере: class(countries) ## [1] &quot;sf&quot; &quot;data.frame&quot; Данная форма записи говорит о том, что прочитанный слой имеет класс sf, который, в свою очередь, является расширением класса data.frame. А теперь посмотрим на последние колонки в первых строках таблицы: head(countries[tail(colnames(countries))]) ## Simple feature collection with 6 features and 5 fields ## geometry type: MULTIPOLYGON ## dimension: XY ## bbox: xmin: -73.41544 ymin: -55.25 xmax: 75.15803 ymax: 42.68825 ## epsg (SRID): 4326 ## proj4string: +proj=longlat +datum=WGS84 +no_defs ## tiny homepart min_zoom min_label max_label ## 1 -99 1 0 3 7 ## 2 -99 1 0 3 7 ## 3 -99 1 0 5 10 ## 4 -99 1 0 4 9 ## 5 -99 1 0 2 7 ## 6 -99 1 0 5 10 ## geometry ## 1 MULTIPOLYGON (((61.21081709... ## 2 MULTIPOLYGON (((23.90415368... ## 3 MULTIPOLYGON (((21.02004031... ## 4 MULTIPOLYGON (((51.57951867... ## 5 MULTIPOLYGON (((-66.95992 -... ## 6 MULTIPOLYGON (((43.58274580... Видно, что геометрия пространственных объектов хранится в заключительном столбце с названием geometry. Данный столбец можно быстро извлечь, применив функцию st_geometry(). Полученный объект будет иметь тип sfc (Simple Feature Geometry Column) outlines &lt;- st_geometry(countries) class(outlines) ## [1] &quot;sfc_MULTIPOLYGON&quot; &quot;sfc&quot; Полученный вывод говорит нам о том, что наши объекты имеют класс sfc_MULTIPOLYGON, который является расширением класса sfc (simple feature geometry column). Теперь если просмотреть начало данных, то мы увидим, что это больше не фрейм данных, а аннотированный список: head(outlines) ## Geometry set for 6 features ## geometry type: MULTIPOLYGON ## dimension: XY ## bbox: xmin: -73.41544 ymin: -55.25 xmax: 75.15803 ymax: 42.68825 ## epsg (SRID): 4326 ## proj4string: +proj=longlat +datum=WGS84 +no_defs ## First 5 geometries: ## MULTIPOLYGON (((61.2108170917257 35.65007233330... ## MULTIPOLYGON (((23.9041536801182 -11.7222815894... ## MULTIPOLYGON (((21.0200403174764 40.84272695572... ## MULTIPOLYGON (((51.5795186704633 24.24549713795... ## MULTIPOLYGON (((-66.95992 -54.8968100000001, -6... Далее можно опуститься на базовый уровень геометрии, получив доступ к отдельному объекту. Поскольку объект класса sfc представляет собой список, любой элемент можно извлечь по его порядковому номеру. Класс полученного объекта будет: class(outlines[[8]]) ## [1] &quot;XY&quot; &quot;MULTIPOLYGON&quot; &quot;sfg&quot; Исходя из полученной информации можно сделать вывод, что геометрия 8-го объекта таблицы countries имеет класс sfg, реализованный в виде мультиполигонов (MULTIPOLYGON) с плоскими координатами (XY) Наконец, чтобы добраться до координат в чистом виде, необходимо развернуть иерархию списков, из которых состоит объект sfg. Количество уровней вложенности всегда зависит от конкретного объекта, их может быть достаточно много, особенно если объекты представлены мультиполигонами (несколько компонент связности), каждый из которых такж состоит из полигонов с дырками. В нашем случае все достаточно просто, так как в слое countries дырок в полигонах нет, а 8-й по счету полигон состоит из одной-единственной геометрии, координаты которой в виде матрицы можно извлечь как: outlines[[8]][[1]] ## [[1]] ## [,1] [,2] ## [1,] 68.9350 -48.6250 ## [2,] 69.5800 -48.9400 ## [3,] 70.5250 -49.0650 ## [4,] 70.5600 -49.2550 ## [5,] 70.2800 -49.7100 ## [6,] 68.7450 -49.7750 ## [7,] 68.7200 -49.2425 ## [8,] 68.8675 -48.8300 ## [9,] 68.9350 -48.6250 6.3.4 Базовые возможности отображения Если попытаться применить функцию plot() к геометрии объекта, она попытается нарисовать тематические карты по всем имеющимся атрибутам (но остановится, если их более 9): plot(countries) Если задача стоит нарисовать границы объектов, то нужно отображать объект sfc: plot(outlines, col = &#39;red&#39;) Для быстрого построения тематических карт по выбранному показателю необходимо при вызове функции plot() указать соответствующий атрибут фрейма данных: plot(countries[&#39;sovereignt&#39;], key.pos = NULL) # Здесь легенда не нужна Для отображения координатной сетки надо указать параметр graticule = TRUE, а подписей координат — axes = TRUE: plot(countries[&#39;gdp_md_est&#39;], graticule = TRUE, axes = TRUE) Ясно, что на этих картах можно много что улучшить, однако это мы отложим до следующей главы, где подробно разбирается построение тематических карт в R. 6.3.5 Пространственная привязка Работа с пространственной привязкой данных в R состоит в основном из четырех операций: чтение информации о системе координат создание информации о системе координат замена информации о системе координат изменение системы координат (проецирование) Первые три операции (чтение, создание, замена) осуществляются функцией st_crs(). Чтобы прочитать информацию о проекции, достаточно передать в качестве параметра объект типа sf: st_crs(countries) # Координатная система ## Coordinate Reference System: ## EPSG: 4326 ## proj4string: &quot;+proj=longlat +datum=WGS84 +no_defs&quot; Эта же функция позволяет создать новую координатную систему, путем передачи ей кода EPSG или строки PROJ.4: st_crs(3857) # Проекция Меркатора для карт мира ## Coordinate Reference System: ## EPSG: 3857 ## proj4string: &quot;+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs&quot; st_crs(54030) # Проекция Робинсона для карт мира ## Coordinate Reference System: ## EPSG: 54030 ## proj4string: &quot;+proj=robin +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs&quot; # Проекция UTM, зона 37. st_crs(&#39;+proj=utm +zone=37 +datum=WGS84 +units=m&#39;) ## Coordinate Reference System: ## EPSG: 32637 ## proj4string: &quot;+proj=utm +zone=37 +datum=WGS84 +units=m +no_defs&quot; Замена координатной системы требуется в тех случаях, когда слой не имеет пространственной привязки, или же она задана некореектно. В этом случае необходимо вызвать для слоя функцию st_crs() и перезаписать результат. st_crs(countries) &lt;- NA st_crs(countries) ## Coordinate Reference System: NA st_crs(countries) &lt;- st_crs(4326) st_crs(countries) ## Coordinate Reference System: ## EPSG: 4326 ## proj4string: &quot;+proj=longlat +datum=WGS84 +no_defs&quot; Внимание: замена координатной системы не осуществляет перепроецирования данных и не меняет координаты точек. Она лишь влияет на то, как эти координаты будут интерпретироваться. Если вместо проецирования выполнить замену информации о координатной системе, данные будут позиционироваться в неправильном месте. Для трансформирования данных в другую проекцию следует использовать функцию st_tranform(x, crs). Данная функция принимает в качестве параметров класс объектов sf и координатную систему, в которую необхоимо проецировать данные. # Проекция Меркатора countries.merc &lt;- st_transform(countries, 3857) plot(st_geometry(countries.merc)) plot(st_geometry(countries.merc), col = &#39;lightgray&#39;, lwd = 0.5, graticule = TRUE, axes = TRUE) # Проекция Робинсона (используем dplyr) countries.rob &lt;- countries %&gt;% st_transform(54030) plot(st_geometry(countries.rob), col = &#39;lightgray&#39;, lwd = 0.5, graticule = TRUE, axes = TRUE) # Зарубежная Европа в Конической равнопромежуточной проекции. # Задаем только необходимые параметры проекции europe.conic &lt;- countries %&gt;% dplyr::filter(continent == &#39;Europe&#39; &amp; sovereignt != &#39;Russia&#39;) %&gt;% st_transform(&#39;+proj=eqdc +lon_0=10 +lat_1=30 +lat_2=60 +datum=WGS84 +units=m&#39;) plot(st_geometry(europe.conic), col = &#39;lightgray&#39;, lwd = 0.5, graticule = TRUE, axes = TRUE) Внимание: чтобы слои данных можно было совместно анализировать и наносить на одну карту, они должны иметь одну и ту же координатную систему (проекцию). 6.3.6 Атрибутивные операции Поскольку пространственные объекты хранятся в фреймах данных, к ним можно применять стандартные операции выборки по атрибутам и преобразования таблиц. Например, можно выбрать Италию и отобразить ее на отдельной карте: library(dplyr) italy &lt;- countries %&gt;% filter(sovereignt == &#39;Italy&#39;) plot(st_geometry(italy)) Следующий пример иллюстрирует как выбрать страны с населением более 100 млн человек: largest &lt;- countries %&gt;% select(pop_est) %&gt;% filter(pop_est &gt; 100000000) plot(outlines, col = &#39;lightgrey&#39;) plot(largest, col = &#39;red&#39;, add = TRUE) Обратите внимание на то, что при вызове функции select() столец geometry не был указан в числе выбираемых переменных. Тем не менее, то, что мы смоги построить карту по результатам выборки, говорит о том, что данный столбец был сохранен. Функции dplyr определены для объектов sf таким образом, чтобы всегда сохранять геометрический столбец. Еще интереснее работает агрегирование объектов по атрибутам. В случае, когда агрегируются пространственные объекты, необходимо объединять и их геометрию. При этом если у агрегируемых объектов имеется общая граница, ее необходимо удалить, а если объекты разнесены в пространстве, из них нужно собрать новый мульти-объект. Например, мы можем агрегировать валовый региональный продукт по континентам: continents &lt;- countries %&gt;% group_by(continent) %&gt;% summarise(gdp = sum(gdp_md_est)) plot(continents[&#39;gdp&#39;]) Потрясающе просто, не правда ли? Вдобавок, мы еще и получили границы континентов (достаточно условные, конечно), которых у нас раньше не было. Данный пример также показывает, что атрибутивные операции над пространственными объектами всегда учитывают их геометрию. 6.3.7 Выборка по местоположению Поиск объектов по местоположению базируется на проверке топологических отношений между объектами. Топологические отношения описывают взаимное расположение объектов. Различные варианты топологических отношений для площадных объектов представлены на следующем рисунке, где серым цветом показаны пересечения внутренних областей объектов \\(A\\) и \\(B\\), синим цветом — пересечения границ объектов \\(A\\) и \\(B\\): Отношение Пересекает (intersects) будет истинно для любого случая когда две геометрии имеют хотя бы одну общую точку, то есть во всех случаях кроме Не пересекает (disjoint). Для проверки этих, а также некоторых других отношений, в пакете sf существуует ряд функций: Функция Топологическое отношение st_intersects(x, y) x имеет общие точки с y st_disjoint(x, y) x не имеет общих точек с y st_touches(x, y) x касается y (граница x имеет общие точки с границей y И внутренняя область x не имеет имеет общих точек с внутренней областью y) st_crosses(x, y) x пересекает y (граница x имеет общие точки с границей y, при этом размерность их пересечения меньше размерности хотя бы одного из исходных обхектов) st_within(x, y) x внутри y (все точки x содержатся в y И внутренняя область x имеет общие точки с внутренней областью y) st_contains(x, y) x содержит y (все точки y содержатся в x И внутренняя область y имеет общие точки с внутренней областью x) st_contains_properly(x, y) x содержит y полностью (все точки y содержатся в x И граница x не имеет общих точек с границей y) st_overlaps(x, y) x перекрывает y (внутренняя область x имеет как общие, так и не общие точки с внутренней областью y) st_equals(x, y) x совпадает y (множества точек x и y совпадают) st_covers(x, y) x покрывает y (все точки y содержатся в x) st_covered_by(x, y) x покрыт y (все точки x содержатся в y) st_equals_exact(x, y) x совпадает y точно (упорядоченные множества точек x и y совпадают) Между covered_by и within, а также covers и contains нет разницы в случае, когда оба объекта являются площадными. Эта разница будет сказываться если хотя бы один из объектов является линией либо точкой. В этом случае within, contains и contains_properly будут давать ложный результат (FALSE), поскольку ни у линий, ни у точек нет внутренней области. Проверка топологических отношений используется для выполнения выборки объектов по местоположению — пространственной выборки. Наиболее простой способ выбрать объекты по пространственному местоположению — это использовать один слой в качестве фильтра для другого слоя. В этом случае будет по умолчанию использовано отношение st_intersects() (пересекает). Никаких отличий от работы с обычными таблицами нет. Например, вот так можно выбрать точки, находящиеся внутри ранее отобранных стран с максимальным ВВП: cities &lt;- st_read(&#39;ne/cities.gpkg&#39;) ## Reading layer `populated_places&#39; from data source `/Volumes/Data/GitHub/r-geo-course/data/ne/cities.gpkg&#39; using driver `GPKG&#39; ## Simple feature collection with 243 features and 103 fields ## geometry type: POINT ## dimension: XY ## bbox: xmin: -175.2206 ymin: -41.29999 xmax: 179.2166 ymax: 64.15002 ## epsg (SRID): 4326 ## proj4string: +proj=longlat +datum=WGS84 +no_defs city.pts &lt;- st_geometry(cities) # Наносим исходную конфигурацию plot(outlines, lwd = 0.5) plot(cities, col = &#39;black&#39;, pch = 20, cex = 0.5, add = TRUE) # Отбираем точки внутри стран с максимальным ВВП sel &lt;- cities[largest, ] ## although coordinates are longitude/latitude, st_intersects assumes that they are planar # Смотрим что получилось plot(outlines, lwd = 0.5) plot(largest, col = &#39;gray&#39;, add = TRUE) plot(sel, pch = 20, col = &#39;black&#39;, add = TRUE) Разумеется, при выполнении пространственных запросов могут возникать и другие пространственные отношения. Например, мы можем выбрать все страны, имеющие общую границу с Чехией. Для этого можно использовать топологическое отношение st_touches вместо st_intersects — это будет гарантировать, что сама Чехия в результате не выберется (касающиеся объекты не могут перекрываться). Тип отношения необходимо поставить в параметр op = при выполнении фильтрации фрейма данных: cz &lt;- countries %&gt;% filter(sovereignt == &#39;Czechia&#39;) neighbors &lt;- countries[cz, op = st_touches] ## although coordinates are longitude/latitude, st_touches assumes that they are planar plot(st_geometry(neighbors), col = &#39;lightgray&#39;, lwd = 0.5) plot(cz, col = &#39;darkgray&#39;, add = TRUE) 6.3.8 Создание и преобразование пространственных объектов Пространственные объекты в R можно собирать “вручную”, если есть такая необходимость. Например, вам известны координаты границ участков полевого обследования, полученные посредством GPS, а вам необходимо превратить их в полигоны, чтобы выполнить анализ и картографирование. Придется из координат собрать полигоны программным путем. Процесс создания пространственных объектов осуществляется в последовательности их иерархического соподчинения: sfg &gt; sfc &gt; sf. 6.3.8.1 Геометрические объекты (sfg) Для создания геометрических объектов в пакете sf существует ряд функций с говорящими названиями: Функция Тип пространственного объекта st_point() POINT st_linestring() LINESTRING st_polygon() POLYGON st_multipoint() MULTIPOINT st_multilinestring() MULTILINESTRING st_multipolygon() MULTIPOLYGON st_geometrycollection() GEOMETRYCOLLECTION В зависимости от типа создаваемого объекта, данные функции принимают координаты, организованные в виде одной из трех структур данных: Вектор координат (POINT) Матрица координат (MULTIPOINT или LINESTRING), в которой строки соответствуют точкам, столбцы — координатам Список (для всех остальных типов) Проще всего создаются отдельные точки (POINT): st_point(c(0, 2)) # XY POINT ## POINT (0 2) st_point(c(0, 2, -1)) # XYZ POINT ## POINT Z (0 2 -1) st_point(c(0, 2, 5), dim = &#39;XYM&#39;) # XYM POINT ## POINT M (0 2 5) st_point(c(0, 2, -1, 5)) # XYZM POINT ## POINT ZM (0 2 -1 5) Дополнительный параметр dim= служит для уточнения типа геометрии точек и по сути нужен только тогда, когда необходимо создать редко используемые точки типа XYM. во всех остальных случаях (XY, XYZ, XYZM) размерность геометрии распознается по умолчанию. При создании мультиточек (MULTIPOINT) и линий (LINESTRING) необходимо подавать на вход функции уже матрицу координат: coords &lt;- matrix(c( 0, 2, 1, 3, 3, 1, 5, 0 ), ncol = 2, byrow = TRUE) mp &lt;- st_multipoint(coords) # XY MULTIPOINT print(mp) ## MULTIPOINT (0 2, 1 3, 3 1, 5 0) ls &lt;- st_linestring(coords) # XY LINESTRING print(ls) ## LINESTRING (0 2, 1 3, 3 1, 5 0) В первом случае геометрия состоит из отдельных точек. Во втором случае те же самые точки соединены линией: plot(ls) plot(mp, col = &#39;red&#39;, pch = 19, add = TRUE) Создание трех-(XYZ, XYM) и четрехмерных (ZYXM) мультиточек и линий выполняется аналогично, но матрица должна содержать не 2, а, соответственно 3 или 4 столбца, и при необходимости параметр dim = 'XYM'. Создание полигонов (POLYGON), мультиполигонов (MULTIPOLYGON) и мультилиний (MULTILINESTRING) требует уже создания списков из матриц. Почему нельзя представить обычный (не мульти) полигон просто матрицей координат? Потому что полигон может содержать дырки. Например, контур леса может содержать дырку в том месте, где находится озеро. Или озеро может содержать дырку в том месте, где находится остров. Природа предлагает нам бесконечное число таких примеров. В целях универсализации приходится закладываться на возможность наличия дырок в полигонах, поэтому даже полигоны без дырок представляются в виде списков. При этом действу.т следующее правила: Первая матрица координат в списке отвечает за контур полигона Все остальные матрицы координат отвечают за дыры в полигоне Координаты первой и последней точки в каждой матрице должны совпадать Если дыр в полигоне нет, его список будет содержать только одну матрицу. Рассмотрим оба примера построения полигонов: coords &lt;- matrix(c( # Координаты главного полигона 1, 0, 0, 2, 2, 3, 4, 2, 3, 0.5, 1, 0 ), ncol = 2, byrow = TRUE) pol &lt;- st_polygon(list(coords)) # Простой полигон print(pol) ## POLYGON ((1 0, 0 2, 2 3, 4 2, 3 0.5, 1 0)) plot(pol, col = &#39;lightblue&#39;) hole &lt;- matrix(c( # Координаты дыры 2, 1, 3, 1.5, 3, 2, 2, 2, 1.5, 1.5, 2, 1 ), ncol = 2, byrow = TRUE) pol2 &lt;- st_polygon(list(coords, hole)) # Полигон с дырой print(pol2) ## POLYGON ((1 0, 0 2, 2 3, 4 2, 3 0.5, 1 0), (2 1, 3 1.5, 3 2, 2 2, 1.5 1.5, 2 1)) plot(pol2, col = &#39;lightblue&#39;) Мультиполигоны (MULTIPOLYGON) и мультилинии (MULTILINESTRING) требуются тогда, когда один и тот же географический объект состоит из нескольких геометрических объектов. Простейший пример — островные государства. Чтобы представить страну, занимающую архипелаг (Багамские острова, Индонезия, Япония и т.д.) как один пространственный объект, необходимо создать мультиполигон. Все компоненты мультиполигона будут иметь общий набор атрибутов (непространственных характеристик). Мультилинии используются реже мультиполигонов и необходимы для представления линейных объектов, разорванных в пространстве. Примером такого объекта может быть любая река или канал, которые разорваны в тех местах, где они протекают через озеро или водохранилище, представленное полигональным объектом. В мультиполигонах добавляется еще один уровень списка, то есть искомые матрицы координат будут располагаться как минимум на втором уровне вложенности: coords1 &lt;- matrix(c( 0.5, 0, 0, 1, 1, 1.5, 2, 1, 1.5, 0.25, 0.5, 0 ), ncol = 2, byrow = TRUE) coords2 &lt;- matrix(c( 3, 1, 2.5, 2, 3.5, 2.5, 4, 2, 4, 1.25, 3, 1 ), ncol = 2, byrow = TRUE) mpol &lt;- st_multipolygon(list(list(coords1), list(coords2))) print(mpol) ## MULTIPOLYGON (((0.5 0, 0 1, 1 1.5, 2 1, 1.5 0.25, 0.5 0)), ((3 1, 2.5 2, 3.5 2.5, 4 2, 4 1.25, 3 1))) plot(pol, col = &#39;grey&#39;) # Обычный полигон (серый) plot(mpol, col = &#39;pink&#39;, add = TRUE) # Мультиполигон (розовый) Как насчет острова на озере? Если остров и суша, окружающая озеро, составляют единое целое (например, подлежат учету как единый массив леса), их можно собрать как мультиполигон. В этом случае первая компонента мультиполигона будет представлять собой полигон с дыркой, а вторая компонента — остров. Порядок компонент в данном случае роли не играет: coords4 &lt;- matrix(c( 2.2, 1.2, 2.8, 1.5, 2.8, 1.8, 2.2, 1.8, 2.0, 1.6, 2.2, 1.2 ), ncol = 2, byrow = TRUE) island &lt;- st_polygon(list(coords4)) mpol2 &lt;- st_multipolygon(list(pol2, island)) print(mpol2) ## MULTIPOLYGON (((1 0, 0 2, 2 3, 4 2, 3 0.5, 1 0), (2 1, 3 1.5, 3 2, 2 2, 1.5 1.5, 2 1)), ((2.2 1.2, 2.8 1.5, 2.8 1.8, 2.2 1.8, 2 1.6, 2.2 1.2))) plot(mpol2, col = &#39;gray&#39;) Из данного примера также видно, что при сборе мультиполигона на самом нижнем уровне вложености можно подавать не списки матриц координат, а готовые полигоны. Мультилиния, в отличие от мультиполигона, не требует дополнительного списка верхнего уровня, поскольку линии не могут содержать дыр. Например, можно собрать мультилинию из двух частей, соответствующих участкам реки до и после озера: coords1 &lt;- matrix(c( -3, 0, -1, 2, 0, 2 ), ncol = 2, byrow = TRUE) coords2 &lt;- matrix(c( 4, 2, 5, 3, 6, 5 ), ncol = 2, byrow = TRUE) mline &lt;- st_multilinestring(list(coords1, coords2)) print(mline) ## MULTILINESTRING ((-3 0, -1 2, 0 2), (4 2, 5 3, 6 5)) plot(mline, lwd = 3, col = &#39;blue&#39;) plot(pol2, col = &#39;lightblue&#39;, add = TRUE) Наконец, еще один вид геометрии — это геометрическая коллекция (GEOMETRYCOLLECTION), который позволяет хранить вместе любые виды геометрий. Эта возможность используется достаточно редко, тем не менее, рассмотреть ее нужно. Геометрическая коллекция собирается из списка объектов с простыми типами геометрии (мы создали их ранее): col &lt;- st_geometrycollection(list(ls, mp, mline, pol2)) print(col) ## GEOMETRYCOLLECTION (LINESTRING (0 2, 1 3, 3 1, 5 0), MULTIPOINT (0 2, 1 3, 3 1, 5 0), MULTILINESTRING ((-3 0, -1 2, 0 2), (4 2, 5 3, 6 5)), POLYGON ((1 0, 0 2, 2 3, 4 2, 3 0.5, 1 0), (2 1, 3 1.5, 3 2, 2 2, 1.5 1.5, 2 1))) plot(col) 6.3.8.2 Списки геометрических объектов (sfc) Списки геометрических объектов (класс sfc) используются в таблицах пространственных объектов в качестве столбца, который хранит геометрию объектов. Создание таких списков осуществляется функцией st_sfc(), которой достаточно передать в качестве перечня параметров объекты типа sfg. Расмотрим создание списка геометрий на примере точечных объектов (для остальных типов объектов порядок действий не меняется): moscow.sfg &lt;- st_point(c(37.615, 55.752)) irkutsk.sfg &lt;- st_point(c(104.296, 52.298)) petro.sfg &lt;- st_point(c(158.651, 53.044)) cities.sfc &lt;- st_sfc(moscow.sfg, irkutsk.sfg, petro.sfg) print(cities.sfc) ## Geometry set for 3 features ## geometry type: POINT ## dimension: XY ## bbox: xmin: 37.615 ymin: 52.298 xmax: 158.651 ymax: 55.752 ## epsg (SRID): NA ## proj4string: NA ## POINT (37.615 55.752) ## POINT (104.296 52.298) ## POINT (158.651 53.044) При создании списка геометрий для него может быть определена система координат (это можно сделать и позднее при создании таблицы пространственных объектов). Для этого используем уже знакомую нам функцию st_crs(): st_crs(cities.sfc) &lt;- st_crs(4326) # WGS84 print(cities.sfc) ## Geometry set for 3 features ## geometry type: POINT ## dimension: XY ## bbox: xmin: 37.615 ymin: 52.298 xmax: 158.651 ymax: 55.752 ## epsg (SRID): 4326 ## proj4string: +proj=longlat +datum=WGS84 +no_defs ## POINT (37.615 55.752) ## POINT (104.296 52.298) ## POINT (158.651 53.044) Для списка геометрий может быть определена только одна система координат Можно посмотреть, куда легли наши точки: plot(cities.sfc, pch = 19) countries %&gt;% filter(sovereignt == &#39;Russia&#39;) %&gt;% st_geometry() %&gt;% plot(add = TRUE) 6.3.8.3 Пространственные объекты (sf) Пространственные объекты (класс sf) организуются в виде фрейма данных, один из столбцов которого имеет класс sfc. Для этого следует сначала создать обычный фрейм данных с атрибутами, а затем соединить его со списком геометрий посредством функции st_sf: city.attr &lt;- data.frame( name = c(&#39;Москва&#39;, &#39;Иркутск&#39;, &#39;Петропавловск-Камчатский&#39;), established = c(1147, 1661, 1740), population = c(12500, 620, 180) ) cites.sf &lt;- st_sf(city.attr, geometry = cities.sfc) print(cites.sf) ## Simple feature collection with 3 features and 3 fields ## geometry type: POINT ## dimension: XY ## bbox: xmin: 37.615 ymin: 52.298 xmax: 158.651 ymax: 55.752 ## epsg (SRID): 4326 ## proj4string: +proj=longlat +datum=WGS84 +no_defs ## name established population geometry ## 1 Москва 1147 12500 POINT (37.615 55.752) ## 2 Иркутск 1661 620 POINT (104.296 52.298) ## 3 Петропавловск-Камчатский 1740 180 POINT (158.651 53.044) 6.3.8.4 Преобразование типов геометрии Для преобразования типов геометрии существует функция st_cast(). Функция принимает объекты классов sfg, sfc или sf, а также название типа геометрии, к которому необходимо привести входные объекты. Довольно часто возникает задача конвертации площадного объекта в линейный и обратно, а также задача получения координат вершин линейного или площадного объекта в виде точек. Примеры преобразований: italy.borders &lt;- st_cast(italy, &#39;MULTILINESTRING&#39;) class(st_geometry(italy.borders)) ## [1] &quot;sfc_MULTILINESTRING&quot; &quot;sfc&quot; italy.regions &lt;- st_cast(italy.borders, &#39;MULTIPOLYGON&#39;) class(st_geometry(italy.regions)) ## [1] &quot;sfc_MULTIPOLYGON&quot; &quot;sfc&quot; italy.points &lt;- st_cast(italy.borders, &#39;POINT&#39;) class(st_geometry(italy.points)) ## [1] &quot;sfc_POINT&quot; &quot;sfc&quot; plot(st_geometry(italy.regions), lwd = 0.5) plot(italy.points, pch = 20, add = TRUE) 6.3.9 Геометрические атрибуты К описательным характеристикам геометрии относятся ограничивающий прямоугольник, периметр (для линий и полигонов) и площадь (для полигонов), которые можно получить с помощью функций st_bbox(), st_area() и st_length() соответственно. Функции корректно работают для простых объектов, мультиобъектов, списков геометрий и пространственных объектов. Применительно к полигону Италии эти параметры будут учитывать части геометрии, занимаемые островами: st_bbox(italy) # Координаты органичивающего прямоугольника ## xmin ymin xmax ymax ## 6.749955 36.619987 18.480247 47.115393 st_area(italy) # Площадь ## 315104851198 m^2 st_length(italy) # Периметр ## Units: m ## [1] 3874043.1 771562.8 677505.2 Обратите внимание на то, что площадь и перметр выводятся с указанием единиц измерений! Это возможно благодаря тому, что объекты типа sf поддерживают единицы измерений на основе пакета units. Если данные находятся в плоской прямоугольной системе координат, то единицы измерения как правило указываются в параметрах проекции — следовательно, они могут быть использованы при вычислении геометрических параметров объектов. Если же данные хранятся в широтах и долготах, то вычисление геометрических параметров осуществляется пакетом sf по формулам сферической тригонометрии через пакет geosphere. Это позволяет выводить результат в плоских единицах измерения. Ограничивающий прямоугольник можно быстро преобразовать в полигон и нанести на карту, применив функцию st_as_sfc(): box &lt;- st_as_sfc(st_bbox(italy)) # Ограничивающий прямоугольник plot(italy %&gt;% st_geometry(), col = &#39;lightgrey&#39;) plot(box, border = &#39;red&#39;, add = TRUE) 6.4 Контрольные вопросы и задачи 6.4.1 Вопросы 6.4.2 Задачи ГОСТ Р 52438-2005 &lt;&gt;. В стандарте поясняется, что объектом может быть неподвижный или движущийся простой или сложный объект, явление, событие, процесс и ситуация. Моделируемый объект может относиться к территории, акватории, недрам и воздушному пространству Земли, околоземному космическому пространству, другим космическим телам и небесной сфере. В широком смысле под пространственным объектом в геоинформатике понимается как сам объект, так и адекватная ему цифровая модель↩ Названия перечисленных компонент геометрии растра укоренились благодаря распространенности стандарта Esri ASCII Grid↩ Например, в широко распространенном формате Esri Shapefile атрибутивная таблица хранится в файле *.dbf формата DBASE, геометрия хранится в отдельном файле *.shp, а связь между ними осуществляется через файл *.shx. Разбиение формата хранения на несколько файлов — это одна из уязвимостей шейп-файлов: при отсутствии хотя бы одного из этих файлов данные прочесть стандартными средствами (без дополнительного хакинга) будет нельзя.↩ "]
]
