# Тематические карты в R {#thematic_mapping_new}

```{r setup, echo = FALSE, purl = FALSE, include=FALSE}
library(datasets)
knitr::opts_knit$set(global.par = TRUE)
knitr::opts_knit$set(root.dir = "data/")
knitr::opts_chunk$set(warning=FALSE, message = FALSE, collapse=TRUE, cache = TRUE)
```

Для выполнения кода данной лекции вам понадобятся следующие пакеты:
```{r}
library(sf)
library(tmap)
library(readxl)
library(raster)
library(mapview)
library(classInt)
library(gapminder)
library(tidyverse)
library(googlesheets)
library(rnaturalearth)
```

## Данные Natural Earth {#thematic_mapping_ne}

[Natural Earth](https://www.naturalearthdata.com/) — это открытые мелкомасштабные картографические данные высокого качества. Данные доступны для трех масштабов: 1:10М, 1:50М и 1:110М. Для доступа к этимм данным из среды R без загрущзки исходных файлов можно использоват пакет [__rnaturalearth__](https://cran.r-project.org/web/packages/rnaturalearth/index.html). Пакет позволяет выгружать данные из внешнего репозитория, а также содержит три предзакачанных слоя:

- `ne_countries()` границы стран
- `ne_states()` границы единиц АТД 1 порядка
- `ne_coastline()` береговая линия

Для загрузки других слоев необходимо использовать функцию `ne_download()`, передав ей масштаб, название слоя и его категорию: 

```{r}
countries = ne_countries() %>% 
  st_as_sf()
coast = ne_coastline() %>% 
  st_as_sf()

ocean = ne_download(scale = 110, type = 'ocean', category = 'physical')

plot(countries %>% st_geometry(), border = 'grey')
plot(ocean, col = 'lightblue', add = TRUE)
plot(coast, add = TRUE, col = 'blue')
```

## Тематические карты tmap {#thematic_mapping_tmap}

Пакет tmap предоставляет простой в использовании и достаточно мощный механизм формирования тематических карт. Шаблон построения карты в этом пакете напоминает _ggplot_ и выглядит следующим образом:
```{r eval=FALSE}
tm_shape(<DATA>) +
  tm_<METHOD>(<PARAMETERS>)
```

где:

- `DATA` - объект пространственного типа (`sf`, `sp`, `stars` или `raster`)
- `METHOD` - метод визуализации этого объекта (спопоб изображения)
- `PARAMETERS` - параметры метода

### Векторные карты {#thematic_mapping_vectors}

Для реализации качественного и количественного фона, а также картограмм используется метод `tm_polygons()`. Он автоматически определяет тип переменной и строит соответствующую шкалу:
```{r}
tm_shape(countries) +
  tm_polygons('economy') # качественная переменная
```

Количественный фон или картограммы получаются при картографировании числового показателя:
```{r}
('1H3nzTwbn8z4lJ5gJ_WfDgCeGEXK3PVGcNjQ_U5og8eo' %>% # продолжительность жизни
  gs_key(lookup = FALSE) %>% # не используем авторизацию
  gs_read(ws = 1) %>% 
  rename(name = 1) %>% 
  gather(year, lifexp, -name) %>% 
  filter(year == 2016) %>% 
  left_join(read_excel('gapminder.xlsx', 2)) %>% 
  mutate(geo = stringr::str_to_upper(geo)) -> lifedf) # выгружаем данные по ВВП на душу населения и сохраняем в переменную lifedf

coun = countries %>% left_join(lifedf, by = c('adm0_a3' = 'geo'))

tm_shape(coun) +
  tm_polygons('lifexp') # количественная переменная
```

Для реализации способа картодиаграмм используется геометрия `tm_bubbles()`. Чтобы оставить отображение границ полигонов, нам необходимо к одной геометрии применить несколько способов изображения:
```{r}
tm_shape(ocean)+
  tm_fill(col = 'lightblue') +
tm_shape(coun) +
  tm_fill() +
  tm_borders() +
  tm_bubbles('gdp_md_est', 
             scale = 3,
             col = 'red', 
             alpha = 0.5) # количественная переменная
```

### Растровые карты {#thematic_mapping_rasters}

При отображени растровых данных используется способ отображения `tm_raster()`:
```{r}
data(land) # мелкомасштабные растры в пакете tmap

tm_shape(land) +
    tm_raster("elevation", palette = terrain.colors(10)) +
tm_shape(ocean) +
  tm_fill(col = 'lightblue') +
  tm_borders(col = 'steelblue')
```

### Интерактивный режим  {#thematic_mapping_interactive}

Любую карту tmap можно превести в интерактивный режим с помощью функции `tmap_mode()` с параметром `'view'`:
```{r}
tmap_mode('view')

tm_shape(coun) +
  tm_polygons('lifexp') # количественная переменная
```

Чтобы добавить карту-подложку, необходимо предварительно вызвать функцию `tm_basemap()`, передав ей название картографического сервиса:
```{r}
tm_basemap("OpenStreetMap") +
tm_shape(coun) +
  tm_polygons('lifexp', alpha = 0.5) # количественная переменная
```

## Контрольные вопросы и упражнения {#questions_tasks_tmap}

### Вопросы {#questions_tmap}

### Упражнения {#tasks_tmap}

1. Используя возможности пакетов __rnaturalearth__ и __tmap__, создпайте карту мира, в которой страны раскрашены в соответствии с континентом (переменная _continent_). Визуализируйте ее в статичном и интерактивном режиме.

2. Выполните выборку стран на Европейский континент. Трансформируйте данные о странах в коническую равнопромежуточную проекцию. Визуализируйте численность населения по странам (переменная _pop\_est_) способом картодиаграмм. Добавьте на карту реки, озера и города, используя возможности `ne_download()`.

----
_Самсонов Т.Е._ **Визуализация и анализ географических данных на языке R.** М.: Географический факультет МГУ, 2017. DOI: 10.5281/zenodo.901911
----