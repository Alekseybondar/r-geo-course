# Пространственные данные {#spatial_data}

```{r setup, echo = FALSE, purl = FALSE, cache = FALSE, include=FALSE}
library(DT)
knitr::opts_knit$set(global.par = TRUE)
knitr::opts_knit$set(root.dir = "data/")
```

__Необходимые пакеты:__ `sf, raster, dplyr, RColorBrewer`

Данный модуль посвящен введению в работу с пространственными данными в R. Рассмотрены общие вопросы моделирования реального мира средствами моделей пространственных данных. Рассматривается чтение векторных и растровых данных, их визуализация стандартными средствами.

## Модели пространственных данных {#spatial_models}

__Пространственные данные__ --- это данные о пространственных объектах и их наборах. В свою очередь, пространственный объект определяется как _цифровая модель материального или абстрактного объекта реального или виртуального мира с указанием его идентификатора, координатных и атрибутивных данных_ ^[ГОСТ Р 52438-2005 <<Географические информационные системы. Термины и определения>>. В стандарте поясняется, что объектом может быть неподвижный или движущийся простой или сложный объект, явление, событие, процесс и ситуация. Моделируемый объект может относиться к территории, акватории, недрам и воздушному пространству Земли, околоземному космическому пространству, другим космическим телам и небесной сфере. В широком смысле под пространственным объектом в геоинформатике понимается как сам объект, так и адекватная ему цифровая модель].

Если говорить по сути, то пространственные данные можно определить как _данные о географических объектах или явлениях, фиксирующие их местоположение и/или распределение в системе координат, привязанной к телу Земли или любого другого небесного тела_. Таким образом, отличительной особенностью пространственных данных перед непространственными является координатное описание местоположения. Важно знать отличия между векторной и растровой моделью пространственных данных. 

__Векторная модель__ пространственных данных включает описание координатных данных пространственных объектов и, возможно, топологических отношений между ними. Векторные данные фиксируют местоположение и форму объектов в виде геометрических примитивов, таких как точки, линии, полигоны, объемные тела. Выбор модели объекта (например, представить город точкой или полигоном) зависит от масштаба анализа и целей исследования. Векторная модель данных является объектно-ориентированной. 

__Растровая модель__ описывает не объекты, а пространственное распределение некоторой (выбранной исследователем) характеристики. Пространство разбивается регулярной сеткой ячеек, в каждой ячейке фиксируется значение исследуемого параметра (путем статистического осреднения, семплирования в центре ячейки и т.п.). Растровые данные могут быть как количественными (например, поле температуры), так и качественными (например, растр классифицированного снимка, каждая ячейка которого фиксирует принадлежность к тому или иному типу объекта). Таким образом, растровая модель является пространственно-ориентированной (или феномен-ориентированной).

Существуют и другие модели пространственных данных, однако их рассмотрение выходит за рамки настоящей лекции.

В настоящей лекции мы познакомимся с чтением и визуализацией пространственных данных в векторном и растровом формате, а также рассмотрим вопросы связанные с использованием картографических проекций.

### Векторные данные {#simple_features}

__Simple Features__ (официально _Simple Features Access_) --- это стандарт [OGC 06-103](http://www.opengeospatial.org/standards/sfa), разработанный Open Geospatial Consortium (OGC) и реализованный также в виде международного стандарта [ISO 19125](https://www.iso.org/standard/40114.html), который определяет общую модель хранения и доступа к векторным объектам (точка, линия, многоугольник, мульти точечные, мультилинии и т. д.), в географических информационных системах.

Геометрическое представление пространственных объектов базируется на следующих принципах:

- Все геометрии состоят из точек. 
- Точки являются координатами в 2-, 3- или 4-мерном пространстве. 
- Все точки в геометрии имеют одинаковую размерность. 

В дополнение к координатам $X$ и $Y$ имеются два дополнительных дополнительных параметра:

- координата $Z$, обозначающая высоту
- координата $M$, обозначающая некоторую меру, связанную с точкой, а не с признаком в целом (в этом случае это будет атрибут объекта). 

Измерение $M$ может быть использовано, например, для представления времени или линейных координат (для маршрутов).

Координаты простой геометрии всегда содержат компоненты $X$ и $Y$, поэтому все разнообразие возможных представлений определяется наличием или отсутствием дополнительных измерений $Z$ и $M$ Таким образом, получаем __четыре__ варианта геометрии:

- двумерные точки $XY$
- трехмерные точки $XYZ$
- трехмерные точки $XYM$
- четырехмерные точки $XYZM$

В случае использования широт и долгот $X$ соответствует долготе, $Y$ соответствует широте.

Всего стандарт __Simple Features__ включает в себя 17 типов геометрий. Из них наиболее употребительными являются следующие 7:

Тип |	Описание
----|--------------------------------------------------------------------------------
`POINT`	| нуль-мерная геометрия, содержащая одну точку
`LINESTRING` | последовательность точек, соединенных прямыми, несамопересекающимися отрезками; одномерная геометрия
`POLYGON`	| геометрия с положительной площадью (двумерная); последовательность точек, отрезки между которыми формируют замкнутое кольцо без самопересечений; первое кольцо является внешним, ноль и более остальных колец представляют дырки внетри полигона
`MULTIPOINT` | множество точек; геометрия типа `MULTIPOINT` называется _простой_ если ни одна пара точек в `MULTIPOINT` не совпадает
`MULTILINESTRING`	| множество линий
`MULTIPOLYGON`	| множество полигонов
`GEOMETRYCOLLECTION`	| множество геометрий произвольного типа за исключением `GEOMETRYCOLLECTION`

Примеры различных видов геометрий представлены на рисунке ниже:
```{r, echo = FALSE}
library(sf)
p <- rbind(c(3.2,4), c(3,4.6), c(3.8,4.4), c(3.5,3.8), c(3.4,3.6), c(3.9,4.5))
mp <- st_multipoint(p)

s1 <- rbind(c(0,3),c(0,4),c(1,5),c(2,5))
ls <- st_linestring(s1)

s2 <- rbind(c(0.2,3), c(0.2,4), c(1,4.8), c(2,4.8))
s3 <- rbind(c(0,4.4), c(0.6,5))
mls <- st_multilinestring(list(s1,s2,s3))

p1 <- rbind(c(0,0), c(1,0), c(3,2), c(2,4), c(1,4), c(0,0))
p2 <- rbind(c(1,1), c(1,2), c(2,2), c(1,1))
pol <-st_polygon(list(p1,p2))
p3 <- rbind(c(3,0), c(4,0), c(4,1), c(3,1), c(3,0))
p4 <- rbind(c(3.3,0.3), c(3.8,0.3), c(3.8,0.8), c(3.3,0.8), c(3.3,0.3))[5:1,]
p5 <- rbind(c(3,3), c(4,2), c(4,3), c(3,3))
mpol <- st_multipolygon(list(list(p1,p2), list(p3,p4), list(p5)))

gc <- st_geometrycollection(list(mp, mpol, ls))
```

```{r, echo=FALSE,fig.width=16, fig.height=8, fig.show='hold'}
par(mfrow = c(2,3))
plot(mp, cex = 5, pch = 20, main = 'MULTIPOINT', cex.main=3)
plot(ls, lwd = 3, main = 'LINESTRING', cex.main=3)
plot(mls, lwd = 3, main = 'MULTILINESTRING', cex.main=3)
plot(pol, lwd = 3, col = 'grey', main = 'POLYGON', cex.main=3)
plot(mpol, lwd = 3, col = 'grey', main = 'MULTIPOLYGON', cex.main=3)
plot(gc, lwd = 3, col = 'grey', border = 'black', main = 'GEOMETRYCOLLECTION', cex.main=3)
par(mfrow = c(1,1))
```

Оставшиеся виды геометрий _Simple Features_ включают: `CIRCULARSTRING`, `COMPOUNDCURVE`, `CURVEPOLYGON`, `MULTICURVE`, `MULTISURFACE`, `CURVE`, `SURFACE`, `POLYHEDRALSURFACE`, `TIN`, `TRIANGLE`.

Существует два официально закрепленных формата представления SF: _Well-Known Text (WKT)_ и _Well-Known Binary (WKB)_, которые необходимы для чтения таких данных человеком и машиной соответственно.

__Well-Known Text (WKT)__ --- стандарт представления геометрии в виде множества списков координат, в которых координаты вершин разделены пробелами, вершины разделены запятыми, а компоненты полигонов и мультигеометрий заключены в круглые скобки и также разделены запятыми. Вышеприведенной картинке соответствуют следующие строки _WKT_:

```{r, echo=FALSE, collapse=T}
cat(st_as_text(mp))
cat(st_as_text(ls))
cat(st_as_text(mls))
cat(st_as_text(pol))
cat(st_as_text(mpol))
cat(st_as_text(gc))
```

__Well-Known Binary (WKB)__ --- бинарный формат хранения координат. Именно этот формат фактически используется в базах данных, поскольку он обеспечивает высокую скорость чтения и записи данных (в отлиие от текстового). Однако внешний вид данных в формате WKB мало о чем говорит человеку, поскольку он предназначен для чтения компьютером. Например, вышеприведенная строка `LINESTRING` будет выглядеть так:

```{r, echo=FALSE}
cat(st_as_binary(ls))
```

### Растровые данные {#raster_data}

__Растр__ представляет из себя матрицу значений. Каждой ячейке матрицы соответствует прямоугольная пространственная область фиксированного размера, которая называется _пикселом_. Различают растры _непрерывные_ и _категориальные (классифицированные)_. Также необходимо разделять _одноканальные_ и _многоканальные растры_. Примером одноканального растра является цифровая модель рельфа. В виде многоканальных растров часто представляют космические снимки.

В отличие от векторных данных, которые требут указания координат для каждой вершины, регулярно-ячеистый характер растровой модели позволяет вычислять координаты пикселов на основе их индексов. Поэтому фактически растровые данные хранятся в виде линейно упорядоченного списка значений _(raster values)_ и описания геометрии растра _(raster geometry)_.

__Геометрия растра__ определяет, где именно располагаются в пространстве пикселы растра и может быть описана путем указания следующих компонент^[Названия перечисленных компонент геометрии растра укоренились благодаря распространенности стандарта [Esri ASCII Grid](https://en.wikipedia.org/wiki/Esri_grid)]:

Параметр | Назначение
---------|---------
`NCOLS` | Количество столбцов
`NROWS` | Количество строк
`XLLCENTER` | Координата $X$ центра левой нижней ячейки растра
`YLLCENTER` | Координата $Y$ центра левой нижней ячейки растра
`CELLSIZE` | Размер ячейки

Иногда вместо параметров `XLLCENTER`/`YLLCENTER` указываются `XLLCORNER`/`YLLCORNER`, которые кодируют координаты левого нижнего угла, а не центра левой нижней ячейки растра. Выбор одного из двух этих вариантов определяет тип _регистрации растра_, а их значения указывают, в какое именно место необходимо "посадить" растр, чтобы его ячейки заняли соответствующие им области в системе координат. Если геометрия растра характеризуется _анизотропией_, то вместо одного значения `CELLSIZE` могут быть указаны разные размеры ячеек по осям координат `CELLSIZEX` и `CELLSIZEY`. 

В отличие от векторной модели, которая позволяет хранить данные только о нужных географических локациях, растровая модель такой свободы не предоставляет. Матрица ячеек растра всегда покрывает область данных целиком, и за простоту растровой структуры приходится расплачиваться ее неэкономичностью.  Поскольку часто данные имеются не на всю территорию, возникает необходимость кодирования ячеек, для которых данные не известны, специальным числом (назовем его условно `NODATA_VALUE`). Значение этого числа хранится в метаданных растра и позволяет интерпретировать соответствующие ячейки как пустые.

Координаты точек векторных объектов и координаты пикселов растра, вычисленные в соответствии с описанием его геометрии, не имеют содержательного смысла, покуда не известно, в какой системе координат они заданы. Эта информация берется из описания пространственной привязки данных.

## Пространственная привязка {#spatref}

### Компоненты пространственной привязки {#spatref_components}

__Пространственная привязка__ (_spatial reference_ или _georeference_) — важнейшая составляющая пространственных данных, которая говорит нам о том, как правильно интерпретировать координаты объектов. Пространственная привязка в простейшем случае включает несколько фундаментальных компонент:

1. _Эллипсоид вращения_ --- тело, по отношению к которому вычисляются геодезические координаты точек (широты и долготы)
1. _Исходные геодезические даты (датум)_ --- параметры положения эллипсоида в теле Земли
1. _Географическая система координат_ --- включает датум, положение начального меридиана и единицы измерения широт и долгот
1. _Проекция_ --- математический спопоб перехода от географических координат на эллипсоиде к плоским прямоугольным координатам карты.
1. _Плоская прямоугольная система координат_ --- включает проекцию, ее параметры и единицы измерения координат.

Если точки имеют также координаты $Z$, то для их правильной интерпретации необходимы дополнительные компоненты пространственной привязки:

1. _Система счета высот_ (геодезические, нормальные, ортометрические) - определяют содержательный смысл и порядок вычисления высот и глубин (координата Z)
1. _Модель геоида, квазигеоида или эллипсоида_ --- определяет поверхность, относительно которой вычисляются высоты точек.
1. _Вертикальная система координат_ --- фактическая реализация системы счета высот относительно конкретной поверхности относимости с заданным положением нулевого уровня. Например, в России это _Балтийская система нормальных высот_ с нулем в г. Кронштадт.

Аналогичным образом требуется введение системы счета дополнительных координат $M$, если они используются в представлении координат.

### Форматы описания пространственной привязки {#spatref_formats}

Существует три распространенных способа задания (хранения) пространственной привязки:

- _PROJ.4 String_ --- представление в виде строки.
- _WKT (Well-Known Text)_ --- представление в виде иерархического списка.
- _EPSG (European Petroleum Survey Group)_ --- представление в виде числового кода.

Для поиска проекций в перечисленных форматах представления удобно воспользоваться порталом [spatialreference.org](spatialreference.org).

__PROJ.4 String__ --- строковый формат представления информации о пространственной привязки, используемый в библиотеке [PROJ.4](http://proj4.org). Данная библиотека лежит в основе координатных систем пространственных данных, используется в __R__, __Python__, __QGIS__ и прочих средах. Основные параметры строки:
```
+datum     Datum name (see `proj -ld`)
+ellps     Ellipsoid name (see `proj -le`)
+lat_0     Latitude of origin
+lat_1     Latitude of first standard parallel
+lat_2     Latitude of second standard parallel
+lat_ts    Latitude of true scale
+lon_0     Central meridian
+proj      Projection name (see `proj -l`)
+units     meters, US survey feet, etc.
+vunits    vertical units.
+x_0       False easting
+y_0       False northing
+zone      UTM zone
```
Примеры записи координат в формате PROJ.4:

- Географические координаты в _WGS84_ (без проекции):
```{r, echo = FALSE}
cat(st_crs(4326)[['proj4string']])
```

- Координаты в проекции _Web Mercator_ (проекция Google Maps, Яндекс.Карт и т.д.):
```{r, echo = FALSE}
cat(st_crs(3857)[['proj4string']])
```

- Координаты в _конической равнопромежуточной проекции_:
```{r, echo = FALSE}
cat(st_crs(54027)[['proj4string']])
```

- Координаты в проекции _UTM, зона 37_:
```{r, echo = FALSE}
cat(st_crs(32637)[['proj4string']])
```

Запись координат в формате WKT предполагает представление вышеуказанных компонент пространственной привязки к виде иерерхического списка. Например, так будет выглядеть информация о _полярной стереографической проекции для карт России_:

```
PROJCS["WGS 84 / EPSG Russia Polar Stereographic",
    GEOGCS["WGS 84",
        DATUM["WGS_1984",
            SPHEROID["WGS 84",6378137,298.257223563,
                AUTHORITY["EPSG","7030"]],
            AUTHORITY["EPSG","6326"]],
        PRIMEM["Greenwich",0,
            AUTHORITY["EPSG","8901"]],
        UNIT["degree",0.0174532925199433,
            AUTHORITY["EPSG","9122"]],
        AUTHORITY["EPSG","4326"]],
    PROJECTION["Polar_Stereographic"],
    PARAMETER["latitude_of_origin",90],
    PARAMETER["central_meridian",105],
    PARAMETER["scale_factor",0.994],
    PARAMETER["false_easting",2000000],
    PARAMETER["false_northing",2000000],
    UNIT["metre",1,
        AUTHORITY["EPSG","9001"]],
    AXIS["X",EAST],
    AXIS["Y",NORTH],
    AUTHORITY["EPSG","5940"]]
```

__EPSG (European Petroleum Survey Group)__ --- европейская рабочая группа нефтегазовой области, которая ведет реестр систем координат с уникальными цифровыми кодами вида `EPSG:xxxxxx`. Коды EPSG оказались настолько удобны, что используются повсеместно для быстрой инициализации проекций со стандартными параметрами. Например, вышеприведенные проекции имеют следующие коды EPSG:

- _WGS84_: `EPSG:4326`
- _Web Mercator_: `EPSG:3857`
- _UTM_: `EPSG:326..` , например для UTM 37N: `EPSG:32637`

### Преобразование координат {#spatref_transform}

Преобразование координат включает три различных операции:

1. __Трансформирование__ --- пересчет географических координат с одного датума на другой

1. __Проецирование__ --- переход от географических координат к плоским прямоугольным

1. __Обратное проецирование__ --- переход от плоских координат к прямоугольным.

Например, чтобы пересчитать координаты _UTM_ в проекцию _Гаусса-Крюгера_, необходимо:

1. Обратно проецировать координаты в географические _WGS84_
1. Трансформировать географические координаты c _WGS84_ в _ГСК-2011_
1. Проецировать координаты _ГСК-2011_ в проекцию _Гаусса-Крюгера_

_Несоответствие датумов часто является причиной того, что данные из разных наборов плохо совмещаются друг с другом_

## Векторные данные {#vector_data_r}

## Растровые данные {#raster_data_r}

## Контрольные вопросы и задачи {#questions_tasks_spatial}

### Вопросы {#questions_spatial}

### Задачи {#tasks_spatial}
