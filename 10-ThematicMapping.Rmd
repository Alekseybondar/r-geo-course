# Тематические карты в R {#thematic_mapping_new}

```{r setup, echo = FALSE, purl = FALSE, include=FALSE}
library(datasets)
knitr::opts_knit$set(global.par = TRUE)
knitr::opts_knit$set(root.dir = "data/")
knitr::opts_chunk$set(warning=FALSE, message = FALSE, collapse=TRUE, cache = TRUE)
```

## Предварительные условия  {-}

Для выполнения кода данной лекции вам понадобятся следующие пакеты:
```{r}
library(sf)
library(tmap)
library(readxl)
library(raster)
library(mapview)
library(classInt)
library(gapminder)
library(tidyverse)
library(googlesheets)
library(rnaturalearth)
```

## Введение

Тематические карты представляют собой важный инструмент географических исследований. Таблицы и графики не дают полного представления о пространственном распределении изучаемого явления. Это знание способна дать исследователю карта.

Разнообразие типов и видов карт достаточно велико. Комплексные картографические произведения, содержащие многослойный набор объектов, создаются, как правило, средствами геоинформационных пакетов. Такие карты требуют тщательной и кропотливой работы с легендой, устранения графических конфликтов между знаками, многократного редактирования входных данных, условий, фильтров и способов изображения в попытке достичь эстетичного и вместе с тем информативного результата.

В то же время, гораздо большее количество создаваемых в повседневной практике карт носят простой аналитический характер. Такие карты показывают одно, максимум два явления, и могут иллюстрировать входные данные, результаты промежуточных или итоговых расчетов. Создание именно таких карт целесообразно автоматизировать средствами программирования. В этом разделе мы познакомимся с созданием тематических карт средствами пакета [__tmap__](https://cran.r-project.org/web/packages/tmap/index.html). В качестве источника открытых данных мы будем использовать [Natural Earth](https://www.naturalearthdata.com/) и [WorldClim](http://www.worldclim.org/).

### Данные Natural Earth {#thematic_mapping_ne}

[Natural Earth](https://www.naturalearthdata.com/) — это открытые мелкомасштабные картографические данные высокого качества. Данные доступны для трех масштабов: 1:10М, 1:50М и 1:110М. Для доступа к этимм данным из среды R без загрущзки исходных файлов можно использоват пакет [__rnaturalearth__](https://cran.r-project.org/web/packages/rnaturalearth/index.html). Пакет позволяет выгружать данные из внешнего репозитория, а также содержит три предзакачанных слоя:

- `ne_countries()` границы стран
- `ne_states()` границы единиц АТД 1 порядка
- `ne_coastline()` береговая линия

Для загрузки других слоев необходимо использовать функцию `ne_download()`, передав ей масштаб, название слоя и его категорию: 

```{r}
countries = ne_countries() %>% 
  st_as_sf()
coast = ne_coastline() %>% 
  st_as_sf()
ocean = ne_download(scale = 110, type = 'ocean', category = 'physical') %>% 
  st_as_sf()

plot(countries %>% st_geometry(), border = 'grey')
plot(ocean, col = 'lightblue', add = TRUE)
plot(coast, add = TRUE, col = 'steelblue')
```

Перед построением карт мира данные целесообразно спроецировать. Чтобы не трансформировать каждый слой отдельно, можно объединить слои в список и воспользоваться функционалом lapply для множественного трансформирования:
```{r}
lyr = list(ocean = ocean, countries = countries, coast = coast)
lyrp = lapply(lyr, st_transform, crs = "+proj=eck3") # Псевдоцилиндрическая проекция Эккерта

g = st_graticule(lyrp$ocean) %>% st_geometry()

plot(lyrp$countries %>% st_geometry(), border = 'grey', 
     graticule = TRUE,
     axes = TRUE)
plot(lyrp$ocean, col = 'lightblue', border = 'steelblue', add = TRUE)
plot(g, lty = 3, add = TRUE)
```

### Данные WorldClim

[WorldClim](http://www.worldclim.org/) --- это открытые сеточные наборы климатических характеристик с пространственным разрешением от $30''$ (около 1 км) до $10'$ (около 20 км). Данные можно выгрузить в виде файлов GeoTiff, однако эту операцию можно сделать и программным путем через пакет __raster__ --- используя функцию `getData()`. Выполним загрузку 10-минутного растра с суммарным количеством осадков за год:
```{r}
prec = getData("worldclim", var = "prec", res = 10) %>% 
  projectRaster(crs = "+proj=eck3")
class(prec) # это 12-канальный растр
```

Визуализируем на карте
```{r}
ramp = colorRampPalette(c("white", "violetred"))

# Визуализируем данные на январь:
plot(prec, 1, 
     col = ramp(10),
     main = 'Количество осадков в январе, мм',
     box = FALSE,
     axes = FALSE)
plot(lyrp$ocean, add = TRUE, border = 'steelblue', 
     col = 'lightblue')
```

> Использовать программную загрузку целесообразно для небольших наборов данных. Если счет пошел на десятки мегабайт и выше, следует все-таки выкачать данные в виде файла и работать с ним

## Тематические карты tmap {#thematic_mapping_tmap}

Пакет __tmap__ предоставляет простой в использовании и достаточно мощный механизм формирования тематических карт. Шаблон построения карты в этом пакете напоминает _ggplot_ и выглядит следующим образом:
```{r eval=FALSE}
tm_shape(<DATA>) +
  tm_<METHOD>(<PARAMETERS>)
```

где:

- `DATA` - объект пространственного типа (`sf`, `sp`, `stars` или `raster`)
- `METHOD` - метод визуализации этого объекта (спопоб изображения)
- `PARAMETERS` - параметры метода

### Векторные карты {#thematic_mapping_vectors}

Для реализации качественного и количественного фона, а также картограмм используется метод `tm_polygons()`. Он автоматически определяет тип переменной и строит соответствующую шкалу:
```{r}
tm_shape(lyrp$countries) +
  tm_polygons('economy') # качественная переменная
```

Количественный фон или картограммы получаются при картографировании числового показателя:
```{r}
('1H3nzTwbn8z4lJ5gJ_WfDgCeGEXK3PVGcNjQ_U5og8eo' %>% # продолжительность жизни
  gs_key(lookup = FALSE) %>% # не используем авторизацию
  gs_read(ws = 1) %>% 
  rename(name = 1) %>% 
  gather(year, lifexp, -name) %>% 
  filter(year == 2016) %>% 
  left_join(read_excel('gapminder.xlsx', 2)) %>% 
  mutate(geo = stringr::str_to_upper(geo)) -> lifedf) # выгружаем данные по ВВП на душу населения и сохраняем в переменную lifedf

coun = lyrp$countries %>% left_join(lifedf, by = c('adm0_a3' = 'geo'))

tm_shape(coun) +
  tm_polygons('lifexp') # количественная переменная
```

Для реализации способа картодиаграмм используется геометрия `tm_bubbles()`. Чтобы оставить отображение границ полигонов, нам необходимо к одной геометрии применить несколько способов изображения:
```{r}
tm_shape(lyrp$ocean)+
  tm_fill(col = 'lightblue') +
tm_shape(coun) +
  tm_fill(col = 'white') +
  tm_borders(col = 'grey') +
  tm_bubbles('gdp_md_est', 
             scale = 3,
             col = 'red', 
             alpha = 0.5) # количественная переменная
```

### Растровые карты {#thematic_mapping_rasters}

При отображении растровых данных используется способ отображения `tm_raster()`:
```{r}
tm_shape(prec) +
    tm_raster('prec1',
              breaks = c(10, 50, 100, 200, 500, 1000),
              palette = ramp(5), title = 'мм') +
tm_layout(legend.position = c('left', 'bottom'),
          fontfamily = 'OpenSans',
          main.title.size = 1.2,
          main.title = 'Среднемноголетнее количество осадков в январе')
# tm_shape(lyrp$ocean) +
#   tm_fill(col = 'lightblue') +
#   tm_borders(col = 'steelblue')
```

## Классификация {#thematic_mapping_class}

### Методы классификации {#thematic_mapping_class_methods}

Классификация данных --- важнейший этап картографирования, который во многом определяет, как данные будут представлены на карте и какие географические выводы читатель сделает на ее основе. Существует множество методов классификации числовых рядов. Классифицировать данные автоматически можно с помощью функции `classIntervals()` из пакета `classInt`. Наберите в консоли `?classInt` чтобы прочитать справку о методах классификации.

Посмотрим несколько методов классификации. Первый параметр функции `classInt` --- это числовой ряд. Число классов следует передать в параметр `n =`, метод классификации указывается в параметре `style =`.

Для начала попробуем метод равных интервалов, который просто делит размах вариации (диапазон от минимума до максимум) на $n$ равных интервалов. Функция `plot()` применительно к созданной классификации рисует замечательный график, на котором показаны границы классов и  эмпирическая функция распределения показателя. В параметр `pal` можно передать цветовую палитру:
```{r, collapse=TRUE}
# Запишем число классов в переменную
nclasses = 5

intervals = classIntervals(coun$lifexp, n = nclasses, style = "equal")

# извлечь полученные границы можно через $brks
intervals$brks

plot(intervals, pal = ramp(nclasses), cex=0.5, main = "Равные интервалы MIN/MAX")
```

Cозданные интервалы хоть и равны, но не аккуратны. Зато метод классификации `"pretty"` создает также равные интервалы, но может слегка расширить диапазон или добавить 1 класс, чтобы получить границы интервалов, округленные до целых чисел:
```{r, collapse=TRUE}
intervals = classIntervals(coun$lifexp, n = nclasses, style = "pretty")
intervals$brks
plot(intervals, pal = ramp(nclasses), cex=0.5, main = "Округленные равные интервалы")
```

Квантили --- равноколичественные интервалы. В каждом классе содержится одинаковое число объектов:
```{r, collapse=TRUE}
intervals = classIntervals(coun$lifexp, n = nclasses, style = "quantile")
intervals$brks
plot(intervals, pal = ramp(nclasses), cex=0.5, main = "Квантили (равноколичественные)")
```

Метод "естественных интервалов", или метод Фишера-Дженкса позволяет найти классы, максимально однородные внутри и при этом максимально отличающиеся друг от друга:
```{r, collapse=TRUE}
intervals = classIntervals(coun$lifexp, n = nclasses, style = "jenks")
intervals$brks
plot(intervals, pal = ramp(nclasses), cex=0.5, main = "Естественные интервалы")
```

### Применение на картах {#thematic_mapping_class_application}

## Фасетные карты

### Интерактивный режим  {#thematic_mapping_interactive}

Любую карту tmap можно превести в интерактивный режим с помощью функции `tmap_mode()` с параметром `'view'`:
```{r}
tmap_mode('view')

tm_shape(coun) +
  tm_polygons('lifexp') # количественная переменная
```

Чтобы добавить карту-подложку, необходимо предварительно вызвать функцию `tm_basemap()`, передав ей название картографического сервиса:
```{r}
tm_basemap("OpenStreetMap") +
tm_shape(coun) +
  tm_polygons('lifexp', alpha = 0.5) # количественная переменная
```

## Контрольные вопросы и упражнения {#questions_tasks_tmap}

### Вопросы {#questions_tmap}

### Упражнения {#tasks_tmap}

1. Используя возможности пакетов __rnaturalearth__ и __tmap__, создпайте карту мира, в которой страны раскрашены в соответствии с континентом (переменная _continent_). Визуализируйте ее в статичном и интерактивном режиме.

2. Выполните выборку стран на Европейский континент. Трансформируйте данные о странах в коническую равнопромежуточную проекцию. Визуализируйте численность населения по странам (переменная _pop\_est_) способом картодиаграмм. Добавьте на карту реки, озера и города, используя возможности `ne_download()`.

----
_Самсонов Т.Е._ **Визуализация и анализ географических данных на языке R.** М.: Географический факультет МГУ, 2017. DOI: 10.5281/zenodo.901911
----